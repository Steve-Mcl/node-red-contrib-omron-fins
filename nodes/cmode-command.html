<style>
    .c-mode-row > div.c-mode-form-tip.form-tips {
        display: inline-block !important;
        border-radius: 2px;
        margin-top: 2px;
        width: calc(100% - 168px);
        overflow: auto;
    }
    .c-mode-row > label {
        width: 120px !important;
    }
    .c-mode-row > .c-mode-form-input {
        width: calc(100% - 150px) !important;
    }
</style>

<script src="omron-fins/lib/_cmode.js"></script>

<script type="text/javascript">
    (function () {

        function __resize(node) {
            if (!node._sizeHackTimer) {
                node._sizeHackTimer = setTimeout(function () {
                    //hack - prevent node-red calculating UI panel too large due to long text in the tip
                    $(".c-mode-form-tip").css("max-width","unset");
                    $(".c-mode-param-row").css("max-width","unset");
                    node._sizeHackTimer = null;
                }, 300);
            }
        }

        RED.nodes.registerType('C-Mode Command', {
            category: 'OMRON',
            color: '#0090d4',
            defaults: {
                name: { value: "" },
                plcSeries: { value: "CSJP" },
                hostNumber: { value: 0 },
                headerCode: { value: "RR" },
                p1: { value: "" },
                p2: { value: "" },
                p3: { value: "" },
            },
            inputs: 1,
            outputs: 1,
            outputLabels: "C-Mode Command",
            icon: "read.png",
            label: function () {
                return this.name || "C-Mode Command";
            },
            oneditprepare() {
                const node = this;
                const $headerCodeDropdown = $("#node-input-headerCode");
                const $plcSeriesSelect = $("#node-input-plcSeries");
                // debugger
                let cmode = new C_MODE.CModeHelper(node.plcSeries);
                let plcSeries = node.plcSeries;
                let headerCode = node.headerCode;
                let commands = cmode.commands || [];
                $plcSeriesSelect.on("change", function() {
                    // const prevHeaderCode = $headerCodeDropdown.val();
                    plcSeries = $(this).val();
                    $headerCodeDropdown.html("");//clear entries
                    try {
                        cmode = new C_MODE.CModeHelper(plcSeries);
                        commands = (cmode && cmode.commands) || [];
                        for (let index = 0; index < commands.length; index++) {
                            const param = commands[index];
                            const o = $(new Option(param.name, param.headerCode, param.headerCode == node.headerCode));
                            o.html(param.name);
                            $headerCodeDropdown.append(o);
                        }
                    } catch (error) {
                        console.log(error)
                        return;
                    }
                    const other = new Option("- set by msg.headerCode -", "");
                    $(other).html(other.text);// jquery(ify) the DOM object so we can use the html method
                    $headerCodeDropdown.append(other);
                    if(cmode.getCommand(headerCode)) {
                        $headerCodeDropdown.val(headerCode).trigger("change");
                    } else {
                        $headerCodeDropdown.val("").trigger("change");
                    }
                })

                $headerCodeDropdown.on("change", function(e) {
                    headerCode = $(this).val();
                    const cmd = headerCode ? cmode.getCommand(headerCode) : null;
                    const $paramRows = [$(".form-row.c-mode-param-row.param-row-1"), $(".form-row.c-mode-param-row.param-row-2"), $(".form-row.c-mode-param-row.param-row-3")];
                    const $paramLabels = [$(".form-row.c-mode-param-row.param-row-1 > label:first-of-type"), $(".form-row.c-mode-param-row.param-row-2 > label:first-of-type"), $(".form-row.c-mode-param-row.param-row-3 > label:first-of-type")];
                    const $paramValues = [$(".form-row.c-mode-param-row.param-row-1 > input:first-of-type"), $(".form-row.c-mode-param-row.param-row-2 > input:first-of-type"), $(".form-row.c-mode-param-row.param-row-3 > input:first-of-type")];
                    
                    if(cmd) {
                        //known/preset command
                        const reqParams = cmd && cmd.request ? cmd.request : [];
                        for (let index = 0; index < $paramRows.length; index++) {
                            $paramRows[index].hide();
                            $paramValues[index].val("");
                        }
                        for (let index = 0; index < reqParams.length; index++) {
                            const param = reqParams[index];
                            $paramLabels[index].html('<b>P' + (index+1) + ':</b> ' + (param.name || ("Parameter " + (index + 1))) );
                            $paramValues[index].val(node["p" + (index+1)] || "");
                            $paramRows[index].show();
                            let hint = param.hint ? param.hint + '. ' : '';
                            $("#c-mode-tip-p"+(index+1)).text(hint + 'Leave this parameter blank to set it via msg.p' + (index+1) + '.');
                            $("#c-mode-tip-p"+(index+1)).show();
                        }
                        $("#c-mode-tip-header-code").text(cmd.hint);
                        $("#c-mode-tip-header-code").show();

                    } else {
                        for (let index = 0; index < $paramRows.length; index++) {
                            $paramLabels[index].html('<b>P' + (index+1) + ':</b> Data');
                            $paramRows[index].show();
                            $("#c-mode-tip-p"+(index+1)).text('optional: depends on msg.headerCode. Refer to OMRON hostlink manuals. Leave this parameter blank to set it via msg.p' + (index+1) + '.');
                            $("#c-mode-tip-p"+(index+1)).show();
                        }
                        $("#c-mode-tip-header-code").text("Pass the headerCode in via msg.headerCode");
                        $("#c-mode-tip-header-code").show();
                    }
                })
                $(".c-mode-form-tip").hide();//will get show / hid as required when function type is set
                $(".c-mode-param-row").hide();
                
                //hack - prevent node-red calculating UI panel too large due to long text in the tip
                $(".c-mode-form-tip").css("max-width","300px");
                $(".c-mode-form-input").css("max-width","300px");
                setTimeout(() => {
                    $(".c-mode-form-tip").css("max-width","unset");
                    $(".c-mode-form-input").css("max-width","unset");
                }, 300);

                $plcSeriesSelect.val(plcSeries);
                // __resize(node);
            },
            // oneditresize: function(size) {
            //     __resize(this);
            // },
            oneditsave: function(size) {
                this.plcSeries = $("#node-input-plcSeries").val();
                this.headerCode = $("#node-input-headerCode").val();
            }
        });
    })()
</script>

<script type="text/html" data-template-name="C-Mode Command">
    <div class="form-row c-mode-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" class="c-mode-form-input" placeholder="Name">
    </div>
    <div class="form-row c-mode-row">
        <label for="node-input-plcSeries"><i class="fa fa-tag"></i> PLC Type</span></label>

        <select id="node-input-plcSeries" class="c-mode-form-input">;

            <option value="CSJP">CS/CJ/CP</option>
            <option value="CV">CV500/CV1000/CV2000/CVM1</option>
            <option value="Calpha">C/CPM/CPL/CQM</option>
        </select>
    </div>
    <div class="form-row c-mode-row">
        <label for="node-input-hostNumber"><i class="fa fa-tag"></i> Host Number</span></label>
        <input type="text" id="node-input-hostNumber" class="c-mode-form-input" placeholder="Host Number">
    </div>
    <div class="form-row c-mode-row">
        <label for="node-input-headerCode"><i class="fa fa-tag"></i> Header Code</label>
        <select id="node-input-headerCode" class="c-mode-form-input" >
        </select>
        <br>
        <label>&nbsp;</label>
        <div id="c-mode-tip-header-code" class="c-mode-form-tip form-tips"  style="max-width: 300px" hidden></div>
    </div>

    <div class="form-row c-mode-row c-mode-param-row param-row-1">
        <label for="node-input-p1"><i class="fa fa-tag"></i> Parameter</label>
        <input type="text" id="node-input-p1" class="c-mode-form-input" >
        <br>
        <label>&nbsp;</label>
        <div id="c-mode-tip-p1" class="c-mode-form-tip form-tips"  style="max-width: 300px" hidden></div>
    </div>
    <div class="form-row c-mode-row c-mode-param-row param-row-2">
        <label for="node-input-p2"><i class="fa fa-tag"></i> Parameter</label>
        <input type="text" id="node-input-p2" class="c-mode-form-input" >
        <br>
        <label>&nbsp;</label>
        <div id="c-mode-tip-p2" class="c-mode-form-tip form-tips"  style="max-width: 300px" hidden></div>
    </div>
    <div class="form-row c-mode-row c-mode-param-row param-row-3">
        <label for="node-input-p3"><i class="fa fa-tag"></i> Parameter</label>
        <input type="text" id="node-input-p3" class="c-mode-form-input" >
        <br>
        <label>&nbsp;</label>
        <div id="c-mode-tip-p3" class="c-mode-form-tip form-tips"  style="max-width: 300px" hidden></div>
    </div>
</script>

<script type="text/markdown" data-help-name="C-Mode Command">
OMRON C-Mode Command builder.  
### Inputs
:   payload        (string | buffer) :  data to be sent with the command
:  *hostNumber*             (string) :  The host number to send this command to (optional, defaults to 00)
:  *headerCode*             (string) :  The header code (command) to issue (optional, defaults to RR)
</script>